# mock_server — Документация

## Описание
`mock_server` — это простой сервер, созданный с использованием [FastAPI](https://fastapi.tiangolo.com/), который позволяет имитировать работу веб-сервера. Он принимает запросы на любой путь и метод, логирует информацию о них, а также может возвращать разные ответы в зависимости от настроек.

Сервер можно использовать для тестирования клиентских приложений, эмуляции поведения API, проверки обработки ошибок и других задач.

---

## Содержание

1. [Функционал](#функционал)
2. [Установка и запуск](#установка-и-запуск)
3. [Настройка](#настройка)
4. [Примеры использования](#примеры-использования)
5. [Технические детали](#технические-детали)

---

## Функционал

### 1. **Поддержка всех HTTP-методов**
Сервер поддерживает все основные HTTP-методы: `GET`, `POST`, `PUT`, `DELETE`, `PATCH`, `OPTIONS`.

### 2. **Логирование**
Все входящие запросы логируются в консоль. Лог содержит:
- Метод запроса (`request.method`)
- Путь (`path`)
- GET-параметры (`params`)
- Заголовки (`headers`)
- Тело запроса (`data`)
- Флаг `withCredentials` (если передан в теле как JSON)

Для работы в фоновом режиме настроено логгирование в файл, чтобы его включить укажите в env файле путь для сохранения логов BASE_LOG_PATH.

### 3. **Ответы**
Сервер может возвращать:
- Успешный ответ (`2xx`) в формате JSON.
- Ошибку с заданным кодом статуса.
- Ответ в виде файла (текстовый файл `report.txt`), если включена опция `FILE=True`.

### 4. **Задержка**
Можно настроить искусственную задержку ответа с помощью параметра `READ_DELAY`.

### 5. **Удаление заголовка `Content-Type`**
Если включено `REMOVE_CONTENT_TYPE=True`, сервер удалит заголовок `Content-Type` из ответа.

---

## Установка и запуск

### 1. **Через Docker**

#### 1.1. Сборка образа:
```bash
docker build -t mock-server .
```

#### 1.2. Запуск контейнера:
```bash
docker run -d -p 8000:8000 --name mock-server mock-server
```

#### 1.3. Использование `docker-compose`:
```bash
docker-compose up -d
```

---

### 2. **Локально**

#### 2.1. Установите зависимости:
```bash
pip install -r req.txt
```

#### 2.2. Запустите сервер:
```bash
python main.py
```

---

## Настройка

Настройки производятся через `.env` файл или переменные окружения.

| Переменная            | Описание                                                                 | Пример значения |
|----------------------|--------------------------------------------------------------------------|------------------|
| `APP_PORT`           | Порт, на котором будет работать сервер                                   | `8000`           |
| `EXTERNAL_PORT`      | Порт, на котором будет доступен сервер извне                             | `8000`           |
| `RESPONSE_CODE`      | Код статуса ответа сервера                                               | `200`            |
| `READ_DELAY`         | Задержка перед ответом (в секундах)                                      | `0`              |
| `FILE`               | Если `True`, возвращает ответ как текстовый файл                         | `False`          |
| `REMOVE_CONTENT_TYPE`| Если `True`, удаляет заголовок `Content-Type` из ответа                  | `False`          |

> Пример: см. `example.env` или `.env`

---

## Примеры использования

### 1. **Получение данных о запросе**
**GET-запрос**:
```bash
curl "http://localhost:8000/api/data?param1=value1"
```
**Ответ**:
```json
{
  "message": "GET-запрос, путь=/api/data, params={'param1': 'value1'}, headers={}, data=None, withCredentials=None"
}
```

### 2. **POST-запрос с данными**
```bash
curl -X POST http://localhost:8000/submit -H "Content-Type: application/json" -d '{"key":"value"}'
```
**Ответ**:
```json
{
  "message": "POST-запрос, путь=/submit, params={}, headers={'host': 'localhost:8000', 'content-type': 'application/json', ...}, data={'key': 'value'}, withCredentials=None"
}
```

### 3. **Имитация ошибки**
Если `RESPONSE_CODE=500`, то:
```bash
curl http://localhost:8000/test-error
```
**Ответ**:
```json
{
  "detail": "Это детали ошибки."
}
```

### 4. **Скачивание файла**
Если `FILE=True`, то:
```bash
curl http://localhost:8000/download
```
**Результат**: скачивается файл `report.txt` с содержимым.

---

## Технические детали

### 1. **Структура проекта**
```
.
├── settings.py             # Настройки через pydantic
├── .env / example.env      # Файлы с переменными окружения
├── main.py                 # Точка входа, запуск uvicorn
├── app.py                  # Основная логика FastAPI
├── logger.py               # Настройка логгирования
├── req.txt                 # Список зависимостей
├── Dockerfile              # Для сборки Docker-образа
├── docker-compose.yml      # Конфигурация сервиса
└── README.md               # Описание проекта
```

### 2. **Библиотеки**
- `FastAPI` — фреймворк для создания API
- `uvicorn` — ASGI-сервер
- `pydantic` — валидация данных
- `python-dotenv` — чтение переменных окружения из `.env`

### 3. **Логика работы**
- Все запросы направляются в один общий маршрут `/`.
- Сервер анализирует метод, заголовки, тело и параметры.
- Возвращает JSON-ответ, ошибку или файл в зависимости от настроек.
- Можно добавить задержку для имитации медленного соединения.

---

## Лицензия

Проект распространяется под MIT License. Подробности — в файле `LICENSE`.

---
